<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta data-name="scale" data-content-width="750">
    <script src="scale.js"></script>
    <link rel="stylesheet" type="text/css" href="index.css">
    <title></title>
</head>
<body>
    <section id="cover"></section>
    <!-- <audio autoplay="autoplay" src="happy-birthday.mp3"></audio> -->
    <section id="container">
        <section id="look">
            <section id="stage">
                <div id="aroundBox"></div>
                <div id="cakeBox"></div>
            </section>
        </section>
    </section>
<script src="index.js"></script>
<script src="anmation.js"></script>
<script src="orienter.js"></script>
<script>

    var lookController = Controller3D(look, -20, 0, 300)
    var stageController = Controller3D(stage, 0, 576, 0)
    var cakeController = Controller3D(cakeBox, 0, 0, 0)
    var aroundController = Controller3D(aroundBox, 0, 0, 0)

    window.addEventListener('load', () => {
        createCake()
        createAround()
        startAnmation()
    })
</script>
<script>
    const cakeTopWidth = 300
    const cakeCenterWidth = 300
    const cakeBottomWidth = 300

    const candleWidth = 8

    let stageNo

    function createCake() {
        const commonStyle = {
            left: '50%',
            marginLeft: '-150px',
        }

        const cakeLayerTop = new Cylinder(cakeTopWidth, 50, Object.assign({
            background: '#FEFAE9',
            top: '100px',
        }, commonStyle), createHappyBrithday()).appendTo(cakeBox)

        const cakeLayerTopS = new Cylinder(cakeTopWidth, 20, Object.assign({
            background: '#8A6961',
            top: '150px'
        }, commonStyle)).appendTo(cakeBox)
        const cakeLayerCenter = new Cylinder(cakeCenterWidth, 50, Object.assign({
            background: '#fcd690',
            top: '170px'
        }, commonStyle)).appendTo(cakeBox)
        const cakeLayerCenterS = new Cylinder(cakeCenterWidth, 20, Object.assign({
            background: '#8A6961',
            top: '220px'
        }, commonStyle)).appendTo(cakeBox)
        const cakeLayerBottom = new Cylinder(cakeBottomWidth, 50, Object.assign({
            background: '#febbaf',
            top: '240px'
        }, commonStyle)).appendTo(cakeBox)
        const cakeLayerBottomS = new Cylinder(cakeBottomWidth, 20, Object.assign({
            background: '#8A6961',
            top: '290px'
        }, commonStyle)).appendTo(cakeBox)

        new Cylinder(candleWidth, 20, Object.assign({
            background: '#8A6961',
            top: '80px',
            left: '-80px'
        })).appendTo(cakeBox)
        new Cylinder(candleWidth, 20, Object.assign({
            background: '#FEFAE9',
            top: '60px',
            left: '-80px'
        })).appendTo(cakeBox)
        new Cylinder(candleWidth, 20, Object.assign({
            background: '#8A6961',
            top: '40px',
            left: '-80px'
        })).appendTo(cakeBox)
        new Cylinder(candleWidth, 20, Object.assign({
            background: '#FEFAE9',
            top: '20px',
            left: '-80px'
        })).appendTo(cakeBox)
        new Cylinder(candleWidth, 20, Object.assign({
            background: '#8A6961',
            top: '0px',
            left: '-80px'
        })).appendTo(cakeBox)

        new Cylinder(candleWidth, 20, Object.assign({
            background: '#8A6961',
            top: '80px',
            right: '-80px'
        })).appendTo(cakeBox)
        new Cylinder(candleWidth, 20, Object.assign({
            background: '#FEFAE9',
            top: '60px',
            right: '-80px'
        })).appendTo(cakeBox)
        new Cylinder(candleWidth, 20, Object.assign({
            background: '#8A6961',
            top: '40px',
            right: '-80px'
        })).appendTo(cakeBox)
        new Cylinder(candleWidth, 20, Object.assign({
            background: '#FEFAE9',
            top: '20px',
            right: '-80px'
        })).appendTo(cakeBox)
        new Cylinder(candleWidth, 20, Object.assign({
            background: '#8A6961',
            top: '0px',
            right: '-80px'
        })).appendTo(cakeBox)

        new Cylinder(14, 14, Object.assign({
            background: '#febbaf',
            top: '-20px',
            right: '-83px',
            borderRadius: '0px'
        })).appendTo(cakeBox)
        new Cylinder(14, 14, Object.assign({
            background: '#febbaf',
            top: '-20px',
            left: '-83px',
            borderRadius: '0px'
        })).appendTo(cakeBox)
    }

    const aroundPicSrc = [
        './a1.jpg', 
        './a1.jpg',
        './a1.jpg',
        './a1.jpg',
        './a1.jpg',
        './a1.jpg',
        './a1.jpg',
        './a1.jpg',
        './a1.jpg',
        './a1.jpg'
    ]

    function createAround() {
        const around = new CylinderX(10, {
            width: '200px',
            height: '200px',
            background: '#FEFAE9',
            top: '-300px',
            border: '20px solid #8A6961',
            borderRadius: '100%',
            opacity: '0.6',
            overflow: 'hidden'
        }, createAroundPic(aroundPicSrc)).appendTo(aroundBox)
        window.deg = around.deg
        window.picZ = around.len
    }

    function createAroundPic(aroundPicSrc) {
        return aroundPicSrc.map(function(item) {
            const img = document.createElement('img')
            img.src = item
            img.style.transform = 'rotateY(180deg)'
            img.style.width = '100%'
            img.style.height = '100%'
            return img
        })
    }

    function createHappyBrithday() {
        const content = document.createElement('p')
        const style = {
            width: cakeTopWidth + 'px',
            height: cakeTopWidth + 'px',
            lineHeight: cakeTopWidth + 'px',
            textAlign: 'center',
            fontSize: '30px',
            color: '#8A6961',
            background: 'url(logo.png) center center no-repeat',
            backgroundSize: '220px 80px'
        }
        for (const key in style)
            content.style[key] = style[key]
        return content
    }
</script>
<script>
    /*
    *
    *  入场动画
    *
    */
    function startAnmation() {
        const director = new Anmation()
        director.add(
            stage, {
                startStyle: {
                    transform: 'rotateX(0deg) rotateY(0deg) translateZ(0px)'
                },
                endStyle: {
                    transform: 'rotateX(0deg) rotateY(576deg) translateZ(0px)'
                },
                startIn: 0,
                // endIn: 10
                endIn: 7000
            }
        )
        director.add(
            look, {
                startStyle: {
                    transform: 'rotateX(0deg) rotateY(0deg) translateZ(-8000px)'
                },
                endStyle: {
                    transform: 'rotateX(-20deg) rotateY(0deg) translateZ(300px)'
                },
                startIn: 0,
                // endIn: 10
                endIn: 4000
            }
        )
        const x = window.innerWidth / 2
        const y = window.innerHeight / 2
        let r = 0

        director.add(
            cover, {
                startIn: 0,
                // endIn: 0
                endIn: 16000
            }, false, () => {
                r += 2
                cover.style.background = `-webkit-gradient(radial,${x} ${y},0,${x} ${y},${r},from(rgba(0, 0, 0, 0)), to(rgba(0, 0, 0, 1)))`
            }
        )

        for (let i = 1, len = aroundPicSrc.length + 1; i < len; i ++) {
            director.add(
                aroundBox, {
                    startIn: (i + 1) * 8000,
                    endIn: (i + 1) * 8000 + 3000,
                    startStyle: {
                        transform: `rotateY(${(i - 1) * window.deg}deg)`,
                    },
                    endStyle: {
                        transform: `rotateY(${(i) * window.deg}deg)`,
                    }
                }, true
            )
            const item = aroundBox.children[aroundBox.children.length - i]
            director.add(
                item, {
                    startIn: i * 9000,
                    endIn: i * 9000 + 3000,
                    startStyle: {
                        transform: `${item.style.transform}`,
                    },
                    endStyle: {
                        transform: `${item.style.transform.replace(/translateZ\(.+?\)/, '')} translateZ(${window.picZ - 1000}px)`,
                        opacity: '1'
                    }
                }, true
            )
            director.add(
                item, {
                    startIn: i * 12000,
                    endIn: i * 12000 + 3000,
                    startStyle: {
                        transform: `${item.style.transform}`,
                    },
                    endStyle: {
                        transform: `${item.style.transform.replace(/translateZ\(.+?\)/, '')} translateZ(${window.picZ}px)`,
                        opacity: '0.6'
                    }
                }, true
            )
        }
        director.init()
        director.start()
    }
</script>
<script>
    (() => {

        const pos = {
            x: 0,
            y: 0
        }
        let olat, olon, flag = false

        setTimeout(() => {
            const o = new Orienter({
                orient (inf) {
                    if (olat)
                        lookAround(inf.lon - olon, inf.lat - olat)
                    olat = inf.lat
                    olon = inf.lon
                }
            })
            o.init()
        }, 8000)

    })()

    function lookAround(disX, disY) {
        const inf = stageController.getInf()

        if (inf.rotateX + disY > 10 || inf.rotateX + disY < -20)
            return

        stageController.rotateY(disX)
        stageController.rotateX(disY)
        stageController.update()
    }

    function lookLear(bool = true, dis = 10) {
        const inf = lookController.getInf()

        if (inf.translateZ + dis > 400 || inf.translateZ + dis < -2000)
            return
        if (bool)
            lookController.translateZ(10)
        else   
            lookController.translateZ(-10)
        lookController.update()
    }
</script>
</body>
</html>